name: Check Megakino Domain
on:
  schedule:
    - cron: '*/5 * * * *'  # Alle 5 Minuten
  workflow_dispatch:

permissions:
  contents: write  # â† Das ist der wichtige Teil!

jobs:
  check-megakino:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Read current domain
        id: read
        run: |
          CURRENT_DOMAIN=$(cat current-megakino-domain.txt | tr -d '\n\r')
          
          # FÃ¼ge https:// hinzu, falls nicht vorhanden
          if [[ ! "$CURRENT_DOMAIN" =~ ^https?:// ]]; then
            CURRENT_DOMAIN="https://$CURRENT_DOMAIN"
          fi
          
          echo "current_domain=$CURRENT_DOMAIN" >> $GITHUB_OUTPUT
          echo "ğŸ“ Aktuelle Megakino Domain: $CURRENT_DOMAIN"
      
      - name: Check for redirect
        id: check
        run: |
          DOMAIN="${{ steps.read.outputs.current_domain }}"
          
          # Folge allen Redirects und hole die finale URL
          FINAL_URL=$(curl -sLI -o /dev/null -w '%{url_effective}' "$DOMAIN")
          
          # Entferne trailing slash fÃ¼r Vergleich
          DOMAIN_CLEAN=$(echo "$DOMAIN" | sed 's:/*$::')
          FINAL_URL_CLEAN=$(echo "$FINAL_URL" | sed 's:/*$::')
          
          echo "final_url=$FINAL_URL_CLEAN" >> $GITHUB_OUTPUT
          
          if [ "$FINAL_URL_CLEAN" != "$DOMAIN_CLEAN" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Redirect erkannt: $DOMAIN_CLEAN â†’ $FINAL_URL_CLEAN"
            
            # Extrahiere nur die Domain (ohne https://)
            NEW_DOMAIN=$(echo "$FINAL_URL_CLEAN" | sed -e 's|^https\?://||')
            echo "new_domain=$NEW_DOMAIN" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… Keine Ã„nderung bei Megakino: $DOMAIN_CLEAN"
          fi
      
      - name: Update files
        if: steps.check.outputs.changed == 'true'
        run: |
          # Aktualisiere aktuelle Domain
          echo "${{ steps.check.outputs.new_domain }}" > current-megakino-domain.txt
          
          # FÃ¼ge zur History hinzu
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          OLD_DOMAIN=$(echo "${{ steps.read.outputs.current_domain }}" | sed -e 's|^https\?://||')
          echo "$TIMESTAMP | $OLD_DOMAIN â†’ ${{ steps.check.outputs.new_domain }}" >> megakino-domain-history.txt
          
          echo "ğŸ“ Megakino Domain-Dateien aktualisiert"
      
      - name: Commit changes
        if: steps.check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add current-megakino-domain.txt megakino-domain-history.txt
          git commit -m "ğŸ”„ Megakino Domain aktualisiert: ${{ steps.check.outputs.new_domain }}"
          git push
